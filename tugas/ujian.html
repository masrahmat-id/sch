<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian - CBT SMP Azzahro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f0f2f5; color: #333; overflow-x: hidden; }
        
        /* Header & Navigasi */
        .header-ujian { background: #1a237e; color: white; padding: 0 15px; position: fixed; top: 0; width: 100%; height: 70px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-sizing: border-box; box-shadow: 0 3px 12px rgba(0,0,0,0.2); }
        .identity-area { display: flex; align-items: center; gap: 10px; }
        .avatar-circle { width: 40px; height: 40px; background: #ffffff33; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ffffff66; }
        
        .nav-right-area { display: flex; align-items: center; gap: 12px; }
        .subject-area { text-align: right; border-right: 1px solid #ffffff44; padding-right: 12px; }
        
        #btn-menu-nomor { 
            background: #283593; 
            color: white; 
            border: 1px solid #ffffff44; 
            border-radius: 10px; 
            width: 42px; 
            height: 42px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.3s; 
        }
        #btn-menu-nomor:hover { background: #3949ab; border-color: white; }

        .menu-nomor-content { display: none; position: fixed; top: 75px; right: 15px; background: white; width: 280px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 20px; z-index: 1000; max-height: 70vh; overflow-y: auto; border: 1px solid #ddd; }
        .menu-nomor-content.show { display: block; animation: fadeIn 0.2s; }
        
        .container { max-width: 800px; margin: 90px auto 20px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 25px; box-sizing: border-box; width: 95%; min-height: 400px; }

        /* Hasil Akhir */
        #hasil-akhir { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px 5px; }
        .info-skor-box { margin: 15px 0; padding: 30px 20px; background: #f8f9fa; border-radius: 20px; width: 100%; max-width: 500px; box-sizing: border-box; border: 2px dashed #dee2e6; }
        
        .display-logika-skor { display: flex; align-items: flex-end; justify-content: center; gap: 10px; margin: 10px 0; }
        .txt-benar { color: #d32f2f; font-size: clamp(70px, 15vw, 100px); font-weight: 900; line-height: 0.8; } 
        .txt-total { color: #ff9800; font-size: clamp(70px, 15vw, 100px); font-weight: 900; line-height: 0.8; } 
        .txt-label-skor { font-weight: 800; color: #555; font-size: 16px; letter-spacing: 1px; padding-bottom: 5px; text-transform: uppercase; }

        .nomor-navigasi { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .kotak-nomor { width: 42px; height: 42px; border: 1px solid #ddd; text-align: center; line-height: 42px; cursor: pointer; border-radius: 8px; font-weight: 700; background: white; transition: 0.2s; }
        .kotak-nomor.sudah { background: #1a237e !important; color: white !important; }
        .kotak-nomor.aktif { border: 3px solid #f9a825; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .btn-group { display: flex; justify-content: space-between; margin-top: 30px; gap: 10px; }
        .btn { padding: 12px 18px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; transition: 0.3s; }
        .btn-back { background: #eceff1; color: #455a64; }
        .btn-next { background: #3949ab; color: white; }
        .btn-finish { background: #1a237e; color: white; }
        
        .moving-dots::after { content: '...'; display: inline-block; animation: flowRight 1.5s infinite; letter-spacing: 2px; }
        @keyframes flowRight { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .soal-card { display: none; }
        .soal-card.active { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .pilihan-label { display: flex; align-items: center; background: #fff; padding: 14px; margin: 10px 0; border: 1px solid #dee2e6; border-radius: 10px; cursor: pointer; }
        
        /* Modal Hitung Mundur */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 380px; text-align: center; }
        .btn-lock { background: #ccc !important; cursor: not-allowed !important; opacity: 0.7; color: #666 !important; }
    </style>
</head>
<body>

<div id="modalConfirm" class="modal-overlay">
    <div class="modal-box">
        <div style="color:#f9a825;"><span class="material-icons-round" style="font-size:60px;">info_outline</span></div>
        <h3 style="margin:15px 0 5px; font-size:22px;">Kirim Jawaban?</h3>
        <p style="font-size:14px; color:#666; line-height:1.4;">Pastikan semua jawaban sudah benar. Tombol kirim terbuka dalam:</p>
        <div id="timer-box" style="font-size:32px; font-weight:900; color:#d32f2f; margin:20px 0; font-family: monospace;">01:00</div>
        <div style="display:flex; gap:10px;">
            <button onclick="tutupModal()" style="flex:1; padding:15px; border-radius:10px; border:1px solid #ddd; cursor:pointer; font-weight:bold;">BATAL</button>
            <button id="btnKirimFinal" class="btn-lock" disabled style="flex:1; background:#1a237e; color:white; border:none; border-radius:10px; font-weight:bold;">YA, KIRIM</button>
        </div>
    </div>
</div>

<div class="header-ujian">
    <div class="identity-area">
        <div class="avatar-circle" id="user-initial">S</div>
        <div class="user-detail">
            <div id="user-name" style="font-weight:700; font-size:14px;">SISWA</div>
            <div id="display-kelas" style="font-size:11px; opacity:0.8;">KELAS</div>
        </div>
    </div>
    <div class="nav-right-area">
        <div class="subject-area">
            <div style="font-size:10px; opacity:0.8;">MATA PELAJARAN</div>
            <div style="font-weight:800; font-size:14px; letter-spacing:1px;">INFORMATIKA</div>
        </div>
        <button id="btn-menu-nomor" onclick="toggleMenuNomor()" title="Daftar Nomor">
            <span class="material-icons-round">grid_view</span>
        </button>
    </div>
</div>

<div id="menu-nomor" class="menu-nomor-content">
    <p style="font-weight:800; font-size:13px; margin:0 0 15px; color:#1a237e; display:flex; align-items:center; gap:5px;">
        <span class="material-icons-round" style="font-size:18px;">list_alt</span> NAVIGASI SOAL
    </p>
    <div class="nomor-navigasi" id="navigasiNomor"></div>
</div>

<div class="container">
    <div id="konten-ujian">
        <div id="konten-soal">Memuat soal...</div>
        <div class="btn-group">
            <button class="btn btn-back" onclick="navigasi(-1)"><span class="material-icons-round">arrow_back</span> KEMBALI</button>
            <button class="btn btn-next" id="btnNext" onclick="navigasi(1)">LANJUT <span class="material-icons-round">arrow_forward</span></button>
            <button class="btn btn-finish" id="btnSubmit" style="display:none;" onclick="cekKelengkapanSebelumSelesai()">SELESAI <span class="material-icons-round">task_alt</span></button>
        </div>
    </div>

    <div id="hasil-akhir">
        <span class="material-icons-round" style="font-size:80px; color:#2e7d32;">check_circle</span>
        <h2 style="margin: 15px 0;">UJIAN SELESAI</h2>
        <div class="info-skor-box">
            <div class="txt-label-skor" style="margin-bottom:20px; color:#1a237e;">PEROLEHAN JAWABAN</div>
            <div class="display-logika-skor">
                <span id="benar-tampil" class="txt-benar">0</span>
                <span class="txt-label-skor">DARI</span>
                <span id="total-tampil" class="txt-total">0</span>
                <span class="txt-label-skor">SOAL</span>
            </div>
            <p style="color:#666; font-size:14px; margin-top:20px;">Jawaban Anda telah berhasil terkirim ke server.</p>
        </div>
        <button class="btn btn-finish" style="padding:18px; max-width:320px; margin-top:15px; font-size:14px;" onclick="sessionStorage.clear(); location.href='index.html'">
            <span class="material-icons-round">logout</span> KEMBALI KE LOGIN
        </button>
    </div>
</div>

<script>
    let dataSoal = []; 
    let jawabanUser = JSON.parse(localStorage.getItem('drafJawaban')) || {}; 
    let indexSekarang = 0;
    
    let timeLeft = 60; 
    let timerRunning = false;
    let timerInterval;

    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyY528MhAel09tDGjpEeXaGNkzf0BCOc8rUJhoW7-F0c8wQ4alSA1L5KZxLy7uT_OQ6/exec';
    
    const userData = JSON.parse(sessionStorage.getItem('userCBT'));
    if (!sessionStorage.getItem('Screen1.Has Permission') || !userData) { 
        window.location.href = 'index.html'; 
    } else { 
        document.getElementById('user-name').innerText = userData.nama; 
        document.getElementById('display-kelas').innerText = "KELAS " + userData.kelas; 
        document.getElementById('user-initial').innerText = userData.nama[0]; 
        muatSoal(); 
    }

    async function muatSoal() { 
        try { 
            const res = await fetch('soal.json'); 
            dataSoal = await res.json(); 
            renderUjian(); 
        } catch (e) { alert("Gagal memuat soal."); } 
    }

    function renderUjian() {
        let html = '';
        dataSoal.forEach((s, i) => {
            html += `<div class="soal-card ${i === indexSekarang ? 'active' : ''}">
                <p style="font-weight:800; color:#1a237e; font-size:14px; margin-bottom:10px;">SOAL NOMOR ${i+1}</p>
                <p style="font-size:18px; line-height:1.6; margin-top:0;">${s.pertanyaan}</p>
                ${s.pilihan.map((p, idx) => `
                    <label class="pilihan-label">
                        <input type="radio" name="s${i}" ${jawabanUser[i]==idx?'checked':''} onclick="pilih(${i},${idx})"> 
                        <span style="margin-left:12px; font-size:16px;">${p}</span>
                    </label>
                `).join('')}
            </div>`;
        });
        document.getElementById('konten-soal').innerHTML = html; 
        renderNav();
    }

    function toggleMenuNomor() { document.getElementById('menu-nomor').classList.toggle('show'); }
    function keNomor(i) { indexSekarang = i; renderUjian(); document.getElementById('menu-nomor').classList.remove('show'); }
    function navigasi(n) { let target = indexSekarang + n; if(target >= 0 && target < dataSoal.length){ indexSekarang = target; renderUjian(); } }
    function pilih(s, p) { jawabanUser[s] = p; localStorage.setItem('drafJawaban', JSON.stringify(jawabanUser)); renderNav(); }

    function renderNav() {
        let html = ''; 
        dataSoal.forEach((_, i) => {
            let cls = (i === indexSekarang) ? 'aktif' : ''; 
            if (jawabanUser[i] !== undefined) cls += ' sudah';
            html += `<div class="kotak-nomor ${cls}" onclick="keNomor(${i})">${i+1}</div>`;
        });
        document.getElementById('navigasiNomor').innerHTML = html;
        document.getElementById('btnNext').style.display = indexSekarang === dataSoal.length - 1 ? 'none' : 'flex';
        document.getElementById('btnSubmit').style.display = indexSekarang === dataSoal.length - 1 ? 'flex' : 'none';
    }

    // FUNGSI CEK SOAL KOSONG (NOTIFIKASI DIKEMBALIKAN)
    function cekKelengkapanSebelumSelesai() {
        let soalKosong = [];
        dataSoal.forEach((_, i) => {
            if (jawabanUser[i] === undefined) {
                soalKosong.push(i + 1);
            }
        });

        if (soalKosong.length > 0) {
            alert("⚠️ UJIAN BELUM LENGKAP!\n\nNomor soal yang belum dijawab:\n" + soalKosong.join(", ") + "\n\nSilakan lengkapi semua jawaban terlebih dahulu.");
        } else {
            bukaModalKonfirmasi();
        }
    }

    function mulaiTimerSistem() {
        if (timerRunning) return;
        timerRunning = true;
        timerInterval = setInterval(() => {
            if (timeLeft > 0) {
                timeLeft--;
                updateTampilanTimer();
            } else {
                clearInterval(timerInterval);
                timerRunning = false;
                aktifkanTombolKirim();
            }
        }, 1000);
    }

    function updateTampilanTimer() {
        const timerDisplay = document.getElementById('timer-box');
        if (timerDisplay) {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            timerDisplay.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
    }

    function aktifkanTombolKirim() {
        const btn = document.getElementById('btnKirimFinal');
        const timerDisplay = document.getElementById('timer-box');
        if (btn) {
            btn.disabled = false;
            btn.className = ''; 
            btn.style.background = '#1a237e';
            btn.style.cursor = 'pointer';
            btn.onclick = kirimJawaban;
        }
        if (timerDisplay) timerDisplay.innerText = "SIAP!";
    }

    function bukaModalKonfirmasi() {
        document.getElementById('modalConfirm').style.display = 'flex';
        updateTampilanTimer();
        if (timeLeft <= 0) {
            aktifkanTombolKirim();
        } else {
            mulaiTimerSistem();
        }
    }

    function tutupModal() {
        document.getElementById('modalConfirm').style.display = 'none';
    }

    async function kirimJawaban() {
        const btn = document.getElementById('btnKirimFinal');
        btn.innerHTML = 'MENGIRIM <span class="moving-dots"></span>';
        btn.disabled = true;

        let benar = 0; 
        let detailJawaban = [];
        const opsiLabel = ["A", "B", "C", "D"];
        dataSoal.forEach((s, i) => { 
            if(jawabanUser[i] == s.jawaban) benar++; 
            detailJawaban.push(`No${i+1}:${opsiLabel[jawabanUser[i]] || '-'}`);
        });

        try {
            const finalURL = `${SCRIPT_URL}?nama=${encodeURIComponent(userData.nama)}&kelas=${userData.kelas}&mapel=INFORMATIKA&benar=${benar}&salah=${dataSoal.length - benar}&jawabanUser=${encodeURIComponent(detailJawaban.join(", "))}`;
            await fetch(finalURL, { mode: 'no-cors' });

            document.getElementById('modalConfirm').style.display = 'none';
            document.getElementById('konten-ujian').style.display = 'none';
            document.getElementById('btn-menu-nomor').style.display = 'none'; 
            document.getElementById('hasil-akhir').style.display = 'flex';
            document.getElementById('benar-tampil').innerText = benar;
            document.getElementById('total-tampil').innerText = dataSoal.length;
            localStorage.removeItem('drafJawaban'); 
        } catch (e) {
            alert("Gagal mengirim.");
            btn.innerHTML = 'COBA LAGI';
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
