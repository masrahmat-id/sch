<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian - CBT SMP Azzahro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .header-ujian { background: #1a237e; color: white; padding: 0 25px; position: fixed; top: 0; width: 100%; height: 70px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-sizing: border-box; box-shadow: 0 3px 12px rgba(0,0,0,0.2); }
        .identity-area { display: flex; align-items: center; gap: 15px; }
        .avatar-circle { width: 45px; height: 45px; background: #ffffff33; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #ffffff66; font-size: 20px; }
        .subject-area { text-align: right; border-left: 2px solid #ffffff; padding-left: 15px; }
        .container { max-width: 850px; margin: 100px auto 40px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 35px; min-height: 400px; }
        #konten-ujian { display: block; }
        #hasil-akhir { display: none; text-align: center; padding: 40px 10px; }
        .soal-card { display: none; }
        .soal-card.active { display: block; animation: slideIn 0.4s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .pilihan-label { display: flex; align-items: center; background: #ffffff; padding: 16px; margin: 12px 0; border: 1px solid #dee2e6; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .pilihan-label:hover { background: #f8f9fa; border-color: #1a237e; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn:active { transform: scale(0.95); }
        .btn-back { background: #607d8b; color: white; }
        .btn-next { background: #3949ab; color: white; }
        .btn-finish { background: #1a237e; color: white; }
        .btn-sending { background: #d32f2f !important; color: white !important; cursor: not-allowed; }
        .moving-dots::after { content: '...'; display: inline-block; animation: flowRight 1.5s infinite; letter-spacing: 2px; }
        @keyframes flowRight { 0% { opacity: 0; transform: translateX(-5px); } 50% { opacity: 1; transform: translateX(0px); } 100% { opacity: 0; transform: translateX(5px); } }
        .skor-besar { color: #d32f2f; font-size: 82px; font-weight: 900; margin: 10px 0; display: block; }
        .nomor-navigasi { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 30px; justify-content: center; }
        .kotak-nomor { width: 38px; height: 38px; border: 1px solid #ddd; text-align: center; line-height: 38px; cursor: pointer; border-radius: 6px; font-weight: 600; background: white; transition: 0.2s; }
        .kotak-nomor.sudah { background: #1a237e !important; color: white !important; }
        .kotak-nomor.aktif { border: 3px solid #f9a825; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Modal Style Improvements */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 40px; border-radius: 20px; max-width: 400px; width: 85%; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .icon-circle { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; }
        .icon-circle .material-icons-round { font-size: 50px; }
        .icon-warn { background: #fff3e0; color: #f9a825; } 
        .icon-error { background: #ffebee; color: #c62828; } 
        .icon-success { background: #e8f5e9; color: #2e7d32; }
        
        #modalTitle { margin: 10px 0; font-size: 22px; color: #1a237e; }
        #modalMessage { color: #666; line-height: 1.5; }
    </style>
</head>
<body>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <div id="modalIconContainer" class="icon-circle">
            <span id="innerIcon" class="material-icons-round"></span>
        </div>
        <h3 id="modalTitle">Judul</h3>
        <p id="modalMessage">Pesan.</p>
        <div id="modalButtons" style="display:flex; gap:10px; margin-top:25px;"></div>
    </div>
</div>

<div class="header-ujian">
    <div class="identity-area">
        <div class="avatar-circle" id="user-initial">S</div>
        <div class="user-detail">
            <div id="user-name" style="font-weight:700;">NAMA SISWA</div>
            <div id="display-kelas" style="font-size:12px; opacity:0.8;">KELAS</div>
        </div>
    </div>
    <div class="subject-area">
        <div style="font-size:10px;">Mata Pelajaran</div>
        <div style="font-weight:800; letter-spacing: 1px;">INFORMATIKA</div>
    </div>
</div>

<div class="container">
    <div id="konten-ujian">
        <div id="konten-soal">Memuat soal...</div>
        <div class="btn-group">
            <button class="btn btn-back" onclick="navigasi(-1)">
                <span class="material-icons-round">arrow_back</span> Kembali
            </button>
            <button class="btn btn-next" id="btnNext" onclick="navigasi(1)">
                Berikutnya <span class="material-icons-round">arrow_forward</span>
            </button>
            <button class="btn btn-finish" id="btnSubmit" style="display:none;" onclick="validasiSelesai()">
                Selesai Ujian <span class="material-icons-round">send</span>
            </button>
        </div>
        <div class="nomor-navigasi" id="navigasiNomor"></div>
    </div>

    <div id="hasil-akhir">
        <div class="icon-circle icon-success" style="margin: 0 auto;">
            <span class="material-icons-round">check_circle</span>
        </div>
        <h2 style="margin-top:20px;">UJIAN SELESAI</h2>
        <p>Jawaban berhasil dikirim ke server. Skor Anda:</p>
        <span class="skor-besar" id="skor-tampil">0</span>
        <button class="btn btn-finish" style="padding:15px 30px; margin: 0 auto;" onclick="sessionStorage.clear(); location.href='index.html'">
            <span class="material-icons-round">logout</span> KEMBALI KE LOGIN
        </button>
    </div>
</div>

<script>
    let dataSoal = []; 
    let jawabanUser = JSON.parse(localStorage.getItem('drafJawaban')) || {}; 
    let indexSekarang = 0;
    
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyY528MhAel09tDGjpEeXaGNkzf0BCOc8rUJhoW7-F0c8wQ4alSA1L5KZxLy7uT_OQ6/exec';
    
    const userData = JSON.parse(sessionStorage.getItem('userCBT'));
    if (!sessionStorage.getItem('Screen1.Has Permission') || !userData) { 
        window.location.href = 'index.html'; 
    } else { 
        document.getElementById('user-name').innerText = userData.nama; 
        document.getElementById('display-kelas').innerText = "KELAS " + userData.kelas; 
        document.getElementById('user-initial').innerText = userData.nama[0]; 
        muatSoal(); 
    }

    async function muatSoal() { 
        try { 
            const res = await fetch('soal.json'); 
            dataSoal = await res.json(); 
            renderUjian(); 
        } catch (e) { 
            showNotif('error', 'Gagal', 'Gagal memuat soal. Pastikan file soal.json tersedia.');
        } 
    }

    function renderUjian() {
        let html = '';
        dataSoal.forEach((s, i) => {
            html += `<div class="soal-card ${i === indexSekarang ? 'active' : ''}">
                <p style="font-weight:800; color:#1a237e;">SOAL NOMOR ${i+1}</p>
                <p style="font-size:18px; line-height:1.6;">${s.pertanyaan}</p>
                ${s.pilihan.map((p, idx) => `
                    <label class="pilihan-label">
                        <input type="radio" name="s${i}" ${jawabanUser[i]==idx?'checked':''} onclick="pilih(${i},${idx})"> 
                        <span style="margin-left:10px;">${p}</span>
                    </label>
                `).join('')}
            </div>`;
        });
        document.getElementById('konten-soal').innerHTML = html; 
        renderNav();
    }

    function pilih(s, p) { 
        jawabanUser[s] = p; 
        localStorage.setItem('drafJawaban', JSON.stringify(jawabanUser)); 
        renderNav(); 
    }

    function renderNav() {
        let html = ''; 
        dataSoal.forEach((_, i) => {
            let cls = (i === indexSekarang) ? 'aktif' : ''; 
            if (jawabanUser[i] !== undefined) cls += ' sudah';
            html += `<div class="kotak-nomor ${cls}" onclick="indexSekarang=${i}; renderUjian();">${i+1}</div>`;
        });
        document.getElementById('navigasiNomor').innerHTML = html;
        
        document.getElementById('btnNext').style.display = indexSekarang === dataSoal.length - 1 ? 'none' : 'flex';
        document.getElementById('btnSubmit').style.display = indexSekarang === dataSoal.length - 1 ? 'flex' : 'none';
    }

    function navigasi(n) { 
        let target = indexSekarang + n; 
        if(target >= 0 && target < dataSoal.length){
            indexSekarang = target; 
            renderUjian();
        } 
    }

    function showNotif(type, title, msg, onConfirm = null) {
        const modal = document.getElementById('customModal'); 
        const icon = document.getElementById('innerIcon');
        const btnArea = document.getElementById('modalButtons'); 
        modal.style.display = 'flex';
        
        document.getElementById('modalIconContainer').className = 'icon-circle icon-' + type;
        
        // Memilih icon berdasarkan type
        if(type === 'error') icon.innerText = 'report_gmailerrorred';
        else if(type === 'warn') icon.innerText = 'help_outline';
        else icon.innerText = 'check_circle_outline';
        
        document.getElementById('modalTitle').innerText = title; 
        document.getElementById('modalMessage').innerText = msg;
        
        btnArea.innerHTML = onConfirm ? 
            `<button onclick="document.getElementById('customModal').style.display='none'" style="flex:1; padding:12px; border-radius:8px; border:1px solid #ddd; cursor:pointer; font-weight:bold;">BATAL</button>
             <button id="cfm" style="flex:1; background:#1a237e; color:white; padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;">YA, KIRIM</button>` : 
            `<button onclick="document.getElementById('customModal').style.display='none'" style="width:100%; padding:12px; background:#1a237e; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">OKE</button>`;
        
        if(onConfirm) document.getElementById('cfm').onclick = () => { 
            onConfirm(); 
            document.getElementById('customModal').style.display='none'; 
        };
    }

    function validasiSelesai() {
        let terjawab = Object.keys(jawabanUser).length;
        if(terjawab < dataSoal.length) {
            showNotif('error', 'Belum Lengkap', 'Anda belum menjawab semua soal. Silakan lengkapi terlebih dahulu!');
        } else {
            showNotif('warn', 'Konfirmasi', 'Apakah Anda yakin ingin mengakhiri ujian dan mengirim jawaban?', kirimJawaban);
        }
    }

    async function kirimJawaban() {
        const btn = document.getElementById('btnSubmit'); 
        btn.innerHTML = 'MENGIRIM JAWABAN <span class="moving-dots"></span>';
        btn.className = 'btn btn-sending'; 
        btn.disabled = true;

        let benar = 0; 
        let detailJawaban = [];
        const opsiLabel = ["A", "B", "C", "D"];

        dataSoal.forEach((s, i) => { 
            if(jawabanUser[i] == s.jawaban) benar++; 
            detailJawaban.push(`No${i+1}:${opsiLabel[jawabanUser[i]] || '-'}`);
        });

        let salah = dataSoal.length - benar;
        let jawabanString = detailJawaban.join(", ");

        try {
            const mapel = "INFORMATIKA";
            const finalURL = `${SCRIPT_URL}?nama=${encodeURIComponent(userData.nama)}&kelas=${userData.kelas}&mapel=${encodeURIComponent(mapel)}&benar=${benar}&salah=${salah}&jawabanUser=${encodeURIComponent(jawabanString)}`;

            await fetch(finalURL, { mode: 'no-cors' });

            document.getElementById('konten-ujian').style.display = 'none';
            document.getElementById('hasil-akhir').style.display = 'block';
            document.getElementById('skor-tampil').innerText = benar;
            
            localStorage.removeItem('drafJawaban'); 
        } catch (e) { 
            btn.innerHTML = 'Selesai Ujian <span class="material-icons-round">send</span>'; 
            btn.className = 'btn btn-finish'; 
            btn.disabled = false; 
            showNotif('error', 'Koneksi Gagal', 'Gagal mengirim jawaban. Periksa koneksi internet Anda!');
        }
    }
</script>
</body>
</html>
