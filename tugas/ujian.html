<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian - CBT SMP Azzahro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f0f2f5; color: #333; overflow-x: hidden; }
        
        /* Header & Navigasi */
        .header-ujian { background: #1a237e; color: white; padding: 0 15px; position: fixed; top: 0; width: 100%; height: 70px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-sizing: border-box; box-shadow: 0 3px 12px rgba(0,0,0,0.2); }
        .identity-area { display: flex; align-items: center; gap: 8px; }
        .avatar-circle { width: 35px; height: 35px; background: #ffffff33; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ffffff66; font-size: 14px; }
        
        .nav-right-area { display: flex; align-items: center; gap: 10px; }
        .subject-area { text-align: right; border-right: 1px solid #ffffff44; padding-right: 10px; }
        
        /* Tombol Menu Nomor */
        #btn-menu-nomor { background: #f9a825; color: white; border: none; border-radius: 8px; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        #btn-menu-nomor:hover { background: #ffc107; }

        /* Dropdown Nomor Soal */
        .menu-nomor-content { display: none; position: fixed; top: 75px; right: 15px; background: white; width: 280px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 15px; z-index: 1000; max-height: 70vh; overflow-y: auto; }
        .menu-nomor-content.show { display: block; animation: fadeIn 0.2s; }
        
        .container { max-width: 800px; margin: 90px auto 20px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 25px; box-sizing: border-box; width: 95%; min-height: 300px; }

        /* Hasil Akhir */
        #hasil-akhir { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px 5px; }
        .info-skor-box { margin: 15px 0; padding: 30px 20px; background: #f8f9fa; border-radius: 20px; width: 100%; max-width: 500px; box-sizing: border-box; border: 2px dashed #dee2e6; }
        .display-logika-skor { display: flex; align-items: flex-end; justify-content: center; gap: 10px; }
        .txt-benar { color: #d32f2f; font-size: clamp(60px, 12vw, 90px); font-weight: 900; line-height: 0.8; } 
        .txt-total { color: #ff9800; font-size: clamp(60px, 12vw, 90px); font-weight: 900; line-height: 0.8; } 
        .txt-label-skor { font-weight: 800; color: #555; font-size: 14px; letter-spacing: 1px; padding-bottom: 5px; }

        /* Grid Nomor */
        .nomor-navigasi { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .kotak-nomor { width: 40px; height: 40px; border: 1px solid #ddd; text-align: center; line-height: 40px; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 14px; background: #fdfdfd; }
        .kotak-nomor.sudah { background: #1a237e !important; color: white !important; }
        .kotak-nomor.aktif { border: 3px solid #f9a825; transform: scale(1.1); }

        .btn-group { display: flex; justify-content: space-between; margin-top: 30px; gap: 10px; }
        .btn { padding: 12px 18px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; }
        .btn-back { background: #eceff1; color: #455a64; }
        .btn-next { background: #3949ab; color: white; }
        .btn-finish { background: #1a237e; color: white; }
        
        /* Modal & Timer */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; }
        .btn-lock { background: #ccc !important; cursor: not-allowed !important; opacity: 0.7; }
        
        .moving-dots::after { content: '...'; display: inline-block; animation: flowRight 1.5s infinite; }
        @keyframes flowRight { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .soal-card { display: none; }
        .soal-card.active { display: block; }
        .pilihan-label { display: flex; align-items: center; background: #fff; padding: 14px; margin: 10px 0; border: 1px solid #dee2e6; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div id="modalConfirm" class="modal-overlay">
    <div class="modal-box">
        <div style="color:#f9a825;"><span class="material-icons-round" style="font-size:50px;">help_outline</span></div>
        <h3 style="margin:10px 0 5px;">Yakin Selesai?</h3>
        <p style="font-size:14px; color:#666;">Silakan periksa kembali jawaban Anda. Tombol kirim terbuka dalam:</p>
        <div id="timer-box" style="font-size:24px; font-weight:800; color:#d32f2f; margin:15px 0;">01:00</div>
        <div style="display:flex; gap:10px;">
            <button onclick="tutupModal()" style="flex:1; padding:12px; border-radius:8px; border:1px solid #ddd; cursor:pointer;">BATAL</button>
            <button id="btnKirimFinal" class="btn-lock" disabled style="flex:1; background:#1a237e; color:white; border:none; border-radius:8px; font-weight:bold;">KIRIM</button>
        </div>
    </div>
</div>

<div class="header-ujian">
    <div class="identity-area">
        <div class="avatar-circle" id="user-initial">?</div>
        <div class="user-detail">
            <div id="user-name" style="font-weight:700; font-size:12px;">PENGGUNA</div>
            <div id="display-kelas" style="font-size:10px; opacity:0.8;">KELAS</div>
        </div>
    </div>
    
    <div class="nav-right-area">
        <div class="subject-area">
            <div style="font-size:9px; opacity:0.8;">Mata Pelajaran</div>
            <div style="font-weight:800; font-size:12px; letter-spacing:0.5px;">INFORMATIKA</div>
        </div>
        <button id="btn-menu-nomor" onclick="toggleMenuNomor()">
            <span class="material-icons-round">grid_view</span>
        </button>
    </div>
</div>

<div id="menu-nomor" class="menu-nomor-content">
    <p style="font-weight:800; font-size:12px; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:5px;">NAVIGASI SOAL</p>
    <div class="nomor-navigasi" id="navigasiNomor"></div>
</div>

<div class="container">
    <div id="konten-ujian">
        <div id="konten-soal">Memuat soal...</div>
        <div class="btn-group">
            <button class="btn btn-back" onclick="navigasi(-1)"><span class="material-icons-round">arrow_back</span> KEMBALI</button>
            <button class="btn btn-next" id="btnNext" onclick="navigasi(1)">LANJUT <span class="material-icons-round">arrow_forward</span></button>
            <button class="btn btn-finish" id="btnSubmit" style="display:none;" onclick="mulaiKonfirmasi()">SELESAI <span class="material-icons-round">task_alt</span></button>
        </div>
    </div>

    <div id="hasil-akhir">
        <span class="material-icons-round" style="font-size:70px; color:#2e7d32;">check_circle</span>
        <h2 style="margin: 10px 0;">UJIAN SELESAI</h2>
        <div class="info-skor-box">
            <div style="font-size:12px; font-weight:800; color:#1a237e; margin-bottom:20px; letter-spacing:2px;">PEROLEHAN JAWABAN</div>
            <div class="display-logika-skor">
                <span id="benar-tampil" class="txt-benar">0</span>
                <span class="txt-label-skor">DARI</span>
                <span id="total-tampil" class="txt-total">0</span>
                <span class="txt-label-skor">SOAL</span>
            </div>
        </div>
        <button class="btn btn-finish" style="padding:15px; max-width:300px; margin-top:10px;" onclick="sessionStorage.clear(); location.href='index.html'">
            <span class="material-icons-round">logout</span> KEMBALI KE LOGIN
        </button>
    </div>
</div>

<script>
    let dataSoal = []; 
    let jawabanUser = JSON.parse(localStorage.getItem('drafJawaban')) || {}; 
    let indexSekarang = 0;
    let timerInterval;
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyY528MhAel09tDGjpEeXaGNkzf0BCOc8rUJhoW7-F0c8wQ4alSA1L5KZxLy7uT_OQ6/exec';
    
    const userData = JSON.parse(sessionStorage.getItem('userCBT'));
    if (!sessionStorage.getItem('Screen1.Has Permission') || !userData) { 
        window.location.href = 'index.html'; 
    } else { 
        document.getElementById('user-name').innerText = userData.nama; 
        document.getElementById('display-kelas').innerText = "KELAS " + userData.kelas; 
        document.getElementById('user-initial').innerText = userData.nama[0]; 
        muatSoal(); 
    }

    async function muatSoal() { 
        try { 
            const res = await fetch('soal.json'); 
            dataSoal = await res.json(); 
            renderUjian(); 
        } catch (e) { alert("Gagal muat soal."); } 
    }

    function renderUjian() {
        let html = '';
        dataSoal.forEach((s, i) => {
            html += `<div class="soal-card ${i === indexSekarang ? 'active' : ''}">
                <p style="font-weight:800; color:#1a237e; font-size:13px;">SOAL NOMOR ${i+1}</p>
                <p style="font-size:16px; line-height:1.5;">${s.pertanyaan}</p>
                ${s.pilihan.map((p, idx) => `
                    <label class="pilihan-label">
                        <input type="radio" name="s${i}" ${jawabanUser[i]==idx?'checked':''} onclick="pilih(${i},${idx})"> 
                        <span style="margin-left:10px;">${p}</span>
                    </label>
                `).join('')}
            </div>`;
        });
        document.getElementById('konten-soal').innerHTML = html; 
        renderNav();
    }

    function toggleMenuNomor() {
        document.getElementById('menu-nomor').classList.toggle('show');
    }

    function renderNav() {
        let html = ''; 
        dataSoal.forEach((_, i) => {
            let cls = (i === indexSekarang) ? 'aktif' : ''; 
            if (jawabanUser[i] !== undefined) cls += ' sudah';
            html += `<div class="kotak-nomor ${cls}" onclick="keNomor(${i})">${i+1}</div>`;
        });
        document.getElementById('navigasiNomor').innerHTML = html;
        document.getElementById('btnNext').style.display = indexSekarang === dataSoal.length - 1 ? 'none' : 'flex';
        document.getElementById('btnSubmit').style.display = indexSekarang === dataSoal.length - 1 ? 'flex' : 'none';
    }

    function keNomor(i) {
        indexSekarang = i;
        renderUjian();
        document.getElementById('menu-nomor').classList.remove('show');
    }

    function navigasi(n) { 
        let target = indexSekarang + n; 
        if(target >= 0 && target < dataSoal.length){ indexSekarang = target; renderUjian(); } 
    }

    function pilih(s, p) { 
        jawabanUser[s] = p; 
        localStorage.setItem('drafJawaban', JSON.stringify(jawabanUser)); 
        renderNav(); 
    }

    // LOGIKA HITUNG MUNDUR 1 MENIT
    function mulaiKonfirmasi() {
        if(Object.keys(jawabanUser).length < dataSoal.length) {
            alert("Masih ada soal yang belum dijawab!");
            return;
        }
        
        document.getElementById('modalConfirm').style.display = 'flex';
        let timeLeft = 60;
        const btn = document.getElementById('btnKirimFinal');
        const timerDisplay = document.getElementById('timer-box');
        
        btn.disabled = true;
        btn.className = 'btn-lock';
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            timerDisplay.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                btn.disabled = false;
                btn.className = ''; 
                btn.style.cursor = 'pointer';
                timerDisplay.innerText = "SIAP KIRIM!";
                btn.onclick = kirimJawaban;
            }
        }, 1000);
    }

    function tutupModal() {
        clearInterval(timerInterval);
        document.getElementById('modalConfirm').style.display = 'none';
    }

    async function kirimJawaban() {
        const btn = document.getElementById('btnKirimFinal');
        btn.innerHTML = 'MENGIRIM <span class="moving-dots"></span>';
        btn.disabled = true;

        let benar = 0;
        dataSoal.forEach((s, i) => { if(jawabanUser[i] == s.jawaban) benar++; });

        try {
            const finalURL = `${SCRIPT_URL}?nama=${encodeURIComponent(userData.nama)}&benar=${benar}&mapel=INFORMATIKA`;
            await fetch(finalURL, { mode: 'no-cors' });

            // Sembunyikan elemen setelah kirim
            document.getElementById('modalConfirm').style.display = 'none';
            document.getElementById('konten-ujian').style.display = 'none';
            document.getElementById('btn-menu-nomor').style.display = 'none'; // Sembunyikan icon menu
            
            document.getElementById('hasil-akhir').style.display = 'flex';
            document.getElementById('benar-tampil').innerText = benar;
            document.getElementById('total-tampil').innerText = dataSoal.length;
            localStorage.removeItem('drafJawaban'); 
        } catch (e) {
            alert("Gagal mengirim.");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
